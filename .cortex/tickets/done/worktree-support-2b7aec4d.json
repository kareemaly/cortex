{
  "id": "2b7aec4d-192d-4742-84d3-be4b9a7166a2",
  "title": "Worktree Support",
  "body": "## Context\n\nEarly development, no users. Breaking changes are fine. Do not accumulate tech debt.\n\n## Overview\n\nEnable parallel ticket work by spawning each ticket agent in its own git worktree.\n\n**Depends on:** `ticket-workflow-v2` (prompt templates, concludeSession)\n\n---\n\n## Session Schema\n\nAdd to Session struct:\n```go\nWorktreePath   *string `json:\"worktree_path,omitempty\"`\nFeatureBranch  *string `json:\"feature_branch,omitempty\"`\n```\n\n---\n\n## Spawn Flow (when `git.worktrees: true` in config)\n\n1. Create worktree:\n   ```bash\n   git worktree add ~/.cortex/worktrees/<session-id> -b ticket/<slug>\n   ```\n\n2. Store `worktree_path` and `feature_branch` in session\n\n3. Spawn agent in worktree directory (not project root)\n\n4. Use `ticket-worktree.md` prompt instead of `ticket.md`\n\n---\n\n## Approve Flow (worktree)\n\nWhen approve triggered for worktree session:\n- Use `approve-worktree.md` instead of `approve.md`\n- Agent merges to main, pushes, calls `concludeSession`\n\n---\n\n## Cleanup (on concludeSession)\n\nWhen `concludeSession` called for worktree session:\n```bash\ngit worktree remove <path> --force\ngit branch -D ticket/<slug>\n```\n\nRun from project root (not worktree).\n\n---\n\n## Implementation\n\n### Commits\n- `e5c8e4b` feat: implement worktree support for parallel ticket work\n- `61f93c3` Merge branch 'ticket/2026-01-24-worktree-support'\n\n### Key Files Changed\n| File | Change |\n|------|--------|\n| `internal/ticket/ticket.go` | Added `WorktreePath`, `FeatureBranch` to Session |\n| `internal/ticket/store.go` | Updated `SetSession` signature with worktree params |\n| `internal/project/config/config.go` | Added `Worktrees bool` to GitConfig |\n| `internal/worktree/worktree.go` | New: Manager with Create/Remove methods |\n| `internal/core/spawn/spawn.go` | Added UseWorktree to SpawnRequest, worktree creation flow |\n| `internal/daemon/mcp/tools_architect.go` | Pass UseWorktree based on config |\n| `internal/daemon/mcp/tools_ticket.go` | Cleanup worktree in concludeSession |\n\n### Decisions\n- Worktrees created at `~/.cortex/worktrees/<session-id>` (global, not project-relative)\n- Branch naming: `ticket/<slug>` where slug is generated from ticket title\n- Worktree-specific prompt templates (`ticket-worktree.md`, `approve-worktree.md`) fall back to standard templates if not present\n- Cleanup on `concludeSession` logs errors but doesn't fail the operation\n\n### Scope\nImplemented as specified. Prompt template paths already existed in `internal/prompt/prompt.go`.",
  "dates": {
    "created": "2026-01-24T14:46:35Z",
    "updated": "2026-01-24T14:46:35Z",
    "done": "2026-01-24T14:46:35Z"
  },
  "comments": [],
  "session": null
}
