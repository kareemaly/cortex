{
  "id": "214fb227-d0b1-47f6-87ad-62fe8a7cadeb",
  "title": "Ticket Workflow Refactor",
  "body": "Refactor ticket schema and MCP tools to support review status, incremental comments, and flexible lifecycle hooks.\n\n## Schema Changes\n\n### Statuses\nAdd `review` status: `backlog \u2192 progress \u2192 review \u2192 done`\n\n### Dates\n```go\ntype Dates struct {\n    Created  time.Time\n    Updated  time.Time\n    Progress *time.Time  // when first moved to progress\n    Reviewed *time.Time  // when moved to review\n    Done     *time.Time  // when moved to done\n}\n```\n\n### Comments (new)\n```go\ntype CommentType string\nconst (\n    CommentScopeChange CommentType = \"scope_change\"\n    CommentDecision    CommentType = \"decision\"\n    CommentBlocker     CommentType = \"blocker\"\n    CommentProgress    CommentType = \"progress\"\n    CommentQuestion    CommentType = \"question\"\n    CommentRejection   CommentType = \"rejection\"  // user-added when respawning\n    CommentGeneral     CommentType = \"general\"\n)\n\ntype Comment struct {\n    ID        string\n    SessionID string      // empty if user-added\n    Type      CommentType\n    Content   string\n    CreatedAt time.Time\n}\n```\n\nComments live on Ticket (not Session).\n\n### Session\nRemove `Report` and `GitBase`. Keep `StatusEntry` fields as placeholder.\n\n```go\ntype Session struct {\n    ID            string\n    StartedAt     time.Time\n    EndedAt       *time.Time\n    Agent         string\n    TmuxWindow    string\n    CurrentStatus *StatusEntry\n    StatusHistory []StatusEntry\n}\n```\n\n## MCP Ticket Session Tools\n\nReplace current tools (`pickupTicket`, `submitReport`, `approve`) with:\n\n| Tool | Input | Description |\n|------|-------|-------------|\n| `readTicket` | *(none)* | Read assigned ticket |\n| `moveTicketToProgress` | *(none)* | Move to progress, run hook |\n| `moveTicketToReview` | *(none)* | Move to review, run hook |\n| `moveTicketToDone` | *(none)* | Move to done, run hook |\n| `addTicketComment` | `type`, `content` | Add comment, run hook |\n| `concludeSession` | *(none)* | End session, run hook |\n\nAll tools return `{success, hooks_output}` where `hooks_output` is raw stdout from the hook command.\n\n## Lifecycle Hooks\n\n```yaml\nlifecycle:\n  moved_to_progress: <command>\n  moved_to_review: <command>\n  moved_to_done: <command>\n  comment_added: <command>\n  session_ended: <command>\n```\n\nTemplate variables available:\n- `{{.TicketID}}`, `{{.Slug}}`, `{{.Title}}`, `{{.Body}}`\n- `{{.CommentType}}`, `{{.Comment}}` (for comment_added)\n- `{{.SessionID}}`, `{{.Agent}}`\n\nHooks are informational - raw output returned to agent who reads and reacts.\n\n## Store Changes\n\n- Create `review/` directory alongside backlog/progress/done\n- Add `AddComment(ticketID, sessionID, commentType, content)` method\n- Update `Move()` to set appropriate date field\n- Remove `UpdateSessionReport()`\n\n## Kanban TUI\n\nAdd 4th column for Review status.\n\n## Files Affected\n\n- `~/projects/cortex1/internal/ticket/ticket.go` - schema\n- `~/projects/cortex1/internal/ticket/store.go` - new methods\n- `~/projects/cortex1/internal/daemon/mcp/tools_ticket.go` - new tools\n- `~/projects/cortex1/internal/daemon/mcp/types.go` - new I/O types\n- `~/projects/cortex1/internal/project/config/config.go` - new hook types\n- `~/projects/cortex1/internal/lifecycle/` - new hook execution\n- `~/projects/cortex1/internal/cli/tui/kanban/` - 4th column\n- `~/projects/cortex1/internal/daemon/api/` - update handlers for new status\n\n## Implementation\n\n### Commits Pushed\n- `7391797` feat: add review status and comment-based ticket workflow\n\n### Key Files Changed\n- `internal/ticket/ticket.go` - Added StatusReview, CommentType, Comment struct, updated Dates with Progress/Reviewed/Done fields, simplified Session by removing GitBase and Report\n- `internal/ticket/store.go` - Added review status support, AddComment method, updated Move to set date fields, changed AddSession signature\n- `internal/daemon/mcp/tools_ticket.go` - Complete rewrite with new tools (moveTicketToProgress, moveTicketToReview, moveTicketToDone, addTicketComment, concludeSession) plus deprecated backward-compatible wrappers\n- `internal/daemon/mcp/types.go` - Added AddCommentInput/Output, ConcludeSessionInput/Output, CommentOutput, updated DatesOutput and SessionOutput\n- `internal/project/config/config.go` - Added new lifecycle hook configurations\n- `internal/lifecycle/hooks.go` - Added new hook type constants\n- `internal/lifecycle/template.go` - Extended TemplateVars with TicketBody, SessionID, Agent, CommentType, Comment; added WithSession, WithComment methods\n- `internal/cli/tui/kanban/model.go` - Changed from 3 to 4 columns, added review column handling\n- `internal/cli/tui/kanban/styles.go` - Added review column styling (blue color)\n- `internal/daemon/api/types.go` - Added Review to ListAllTicketsResponse, updated date/comment/session structures\n- `internal/cli/sdk/client.go` - Added Review field, updated FindTicketByID to search review status\n\n### Important Decisions\n- Deprecated old tools (pickupTicket, submitReport, approve) but kept them for backward compatibility - they delegate to new implementations\n- Comments are stored at ticket level, not session level, allowing persistence across sessions\n- All MCP tools now return hooks_output field with raw stdout from hook execution\n- Session no longer tracks GitBase or Report - simplified to just status tracking\n\n### Scope Changes\n- None - implementation followed the original ticket spec exactly",
  "dates": {
    "created": "2026-01-22T10:07:19Z",
    "updated": "2026-01-22T10:07:19Z",
    "done": "2026-01-22T10:07:19Z"
  },
  "comments": [],
  "session": null
}
