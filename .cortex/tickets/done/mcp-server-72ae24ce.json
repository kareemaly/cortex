{
  "id": "72ae24ce-331c-4ea6-bc8f-69c1cba804ac",
  "title": "MCP Server",
  "body": "Implement the MCP server that exposes tools for AI agents to interact with tickets.\n\n## Context\n\nAgents interact with cortex via MCP tools, not REST API. The daemon runs an MCP server (stdio transport) that Claude connects to via `--mcp-config`.\n\nSee `DESIGN.md` for:\n- MCP tools table (lines 171-202)\n- Tool parameters and descriptions\n- Hook response format (lines 206-226)\n- MCP config file format (lines 383-396)\n- Agent spawning examples (lines 356-378)\n\n## Requirements\n\nCreate `internal/daemon/mcp/` package that:\n\n1. **MCP Server** using `github.com/modelcontextprotocol/go-sdk`\n   - Stdio transport for Claude integration\n   - Tool registration framework\n\n2. **Architect Session Tools**\n   - `listTickets` - List tickets, optionally filter by status\n   - `searchTickets` - Search by title, keyword, date\n   - `readTicket` - Read full ticket content\n   - `createTicket` - Create ticket in backlog\n   - `updateTicket` - Update ticket title/body\n   - `deleteTicket` - Delete ticket\n   - `moveTicket` - Move ticket between statuses\n   - `spawnSession` - Start tmux + agent for ticket (stub tmux for now)\n   - `getSessionStatus` - Get agent status for ticket\n\n3. **Ticket Session Tools**\n   - `readTicket` - Read own ticket (uses env var for ticket ID)\n   - `pickupTicket` - Signal starting work\n   - `submitReport` - Update session report\n   - `approve` - Approve and conclude ticket\n\n4. **Integration**\n   - Wire MCP server into daemon (new subcommand or mode)\n   - Use `internal/ticket` store for all operations\n   - Return structured responses per DESIGN.md\n\n## Verification\n\n```bash\nmake build   # Builds successfully\nmake test    # Tests pass\nmake lint    # No lint errors\n```\n\n## Notes\n\n- Architect and ticket sessions get different tool sets\n- Ticket session tools use CORTEX_TICKET_ID env var\n- Stub tmux/lifecycle hooks for now - those are separate tickets\n- Focus on tool registration and ticket store integration\n\n## Implementation\n\n### Commits\n\n- `037fb93` feat: add MCP server for AI agent integration with ticket management tools\n\n### Key Files Changed\n\n**New files in `internal/daemon/mcp/`:**\n- `types.go` - Input/output structs with jsonschema tags for schema generation\n- `errors.go` - ToolError type with error codes (NOT_FOUND, VALIDATION_ERROR, UNAUTHORIZED, INTERNAL_ERROR)\n- `server.go` - MCP server setup, session management, tool registration\n- `tools_architect.go` - 9 architect tools (listTickets, searchTickets, readTicket, createTicket, updateTicket, deleteTicket, moveTicket, spawnSession, getSessionStatus)\n- `tools_ticket.go` - 4 ticket tools (readTicket, pickupTicket, submitReport, approve)\n- `server_test.go` - Server initialization tests\n- `tools_test.go` - Comprehensive tool handler tests (26 tests)\n\n**New files in `cmd/cortexd/commands/`:**\n- `root.go` - Root Cobra command for cortexd\n- `serve.go` - HTTP server subcommand (default behavior)\n- `mcp.go` - MCP server subcommand with `--ticket-id` flag\n\n**Modified:**\n- `cmd/cortexd/main.go` - Simplified to call `commands.Execute()`\n- `go.mod` / `go.sum` - Added `github.com/modelcontextprotocol/go-sdk` v1.2.0\n\n### Decisions\n\n1. **Tool registration at startup**: Tools are registered based on session type at server creation, not filtered at runtime\n2. **Struct tags for schemas**: Using `json:\"field\"` and `jsonschema:\"description\"` tags for automatic JSON schema generation per MCP SDK conventions\n3. **spawnSession stub**: Returns \"not implemented\" message since tmux integration is a separate ticket\n4. **Cobra subcommands**: Refactored cortexd to use Cobra pattern matching `cmd/cortex/commands/` structure\n5. **Default behavior**: Running `cortexd` without subcommand defaults to `serve` (HTTP server) for backward compatibility\n\n### Scope\n\nNo scope changes - implemented all requirements as specified.",
  "dates": {
    "created": "2026-01-20T13:06:22Z",
    "updated": "2026-01-20T13:06:22Z",
    "done": "2026-01-20T13:06:22Z"
  },
  "comments": [],
  "session": null
}
