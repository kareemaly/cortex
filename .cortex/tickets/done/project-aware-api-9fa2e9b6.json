{
  "id": "9fa2e9b6-b64e-465d-85f5-317c6c617511",
  "title": "Project-Aware API",
  "body": "Make the HTTP API project-aware so a single daemon can serve multiple projects.\n\n## Context\n\nCurrently `cortexd serve` uses a global `~/.cortex/tickets` directory. We need it to act as a proxy to project-local ticket stores, with each request specifying which project it's for.\n\n**Architecture:**\n- Single global daemon manages ALL projects\n- Multiple architects can run simultaneously for different projects\n- Multiple `cortex kanban` instances from different project directories\n- Each API request specifies which project's tickets to access\n\n## Changes Required\n\n### 1. API Layer - Add Project Header\n\nAll endpoints (except `/health`) must require `X-Cortex-Project` header containing the absolute project path.\n\n**File:** `internal/daemon/api/server.go`\n\nAdd middleware to extract and validate project path:\n```go\nfunc projectMiddleware(next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        projectPath := r.Header.Get(\"X-Cortex-Project\")\n        if projectPath == \"\" {\n            http.Error(w, `{\"error\":\"missing X-Cortex-Project header\"}`, http.StatusBadRequest)\n            return\n        }\n\n        // Validate project exists\n        ticketsDir := filepath.Join(projectPath, \".cortex\", \"tickets\")\n        if _, err := os.Stat(ticketsDir); os.IsNotExist(err) {\n            http.Error(w, `{\"error\":\"project not found or not initialized\"}`, http.StatusNotFound)\n            return\n        }\n\n        // Add to context\n        ctx := context.WithValue(r.Context(), projectPathKey, projectPath)\n        next.ServeHTTP(w, r.WithContext(ctx))\n    })\n}\n```\n\nApply to all routes except `/health`.\n\n### 2. Ticket Store Per Project\n\n**File:** `internal/daemon/api/server.go` or new `internal/daemon/api/stores.go`\n\nReplace single `TicketStore` in Dependencies with a store manager:\n```go\ntype StoreManager struct {\n    stores map[string]*ticket.Store\n    mu     sync.RWMutex\n}\n\nfunc (m *StoreManager) GetStore(projectPath string) (*ticket.Store, error) {\n    m.mu.RLock()\n    if store, ok := m.stores[projectPath]; ok {\n        m.mu.RUnlock()\n        return store, nil\n    }\n    m.mu.RUnlock()\n\n    // Create new store\n    m.mu.Lock()\n    defer m.mu.Unlock()\n\n    // Double-check after acquiring write lock\n    if store, ok := m.stores[projectPath]; ok {\n        return store, nil\n    }\n\n    ticketsDir := filepath.Join(projectPath, \".cortex\", \"tickets\")\n    store, err := ticket.NewStore(ticketsDir)\n    if err != nil {\n        return nil, err\n    }\n    m.stores[projectPath] = store\n    return store, nil\n}\n```\n\n### 3. Update Handlers\n\nAll handlers need to get the ticket store from context:\n```go\nfunc (s *Server) handleListTickets(w http.ResponseWriter, r *http.Request) {\n    projectPath := r.Context().Value(projectPathKey).(string)\n    store, err := s.storeManager.GetStore(projectPath)\n    if err != nil {\n        // handle error\n    }\n    // use store...\n}\n```\n\n### 4. SDK Client Changes\n\n**File:** `internal/cli/sdk/client.go`\n\nAdd project path to client:\n```go\ntype Client struct {\n    baseURL     string\n    projectPath string\n    httpClient  *http.Client\n}\n\nfunc NewClient(baseURL, projectPath string) *Client {\n    return &Client{\n        baseURL:     baseURL,\n        projectPath: projectPath,\n        httpClient:  &http.Client{Timeout: 10 * time.Second},\n    }\n}\n\n// All request methods add the header:\nfunc (c *Client) doRequest(req *http.Request) (*http.Response, error) {\n    if c.projectPath != \"\" {\n        req.Header.Set(\"X-Cortex-Project\", c.projectPath)\n    }\n    return c.httpClient.Do(req)\n}\n```\n\n### 5. CLI Commands\n\n**File:** `cmd/cortex/commands/kanban.go`\n\nResolve project path and pass to SDK:\n```go\nfunc runKanban(cmd *cobra.Command, args []string) {\n    cwd, err := os.Getwd()\n    if err != nil {\n        // handle error\n    }\n\n    _, projectRoot, err := projectconfig.LoadFromPath(cwd)\n    if err != nil {\n        if projectconfig.IsProjectNotFound(err) {\n            fmt.Fprintf(os.Stderr, \"Error: not in a cortex project\\n\")\n            os.Exit(1)\n        }\n        // handle error\n    }\n\n    client := sdk.NewClient(sdk.DefaultBaseURL, projectRoot)\n    // ...\n}\n```\n\n### 6. Remove Global Tickets Directory\n\n**File:** `cmd/cortexd/commands/serve.go`\n\nRemove the global ticket store initialization (lines 74-83). The serve command no longer needs to know about any specific project at startup.\n\nAlso remove `~/.cortex/tickets` from the install process if it exists.\n\n### 7. Update Integration Tests\n\n**File:** `internal/daemon/api/integration_test.go`\n\nTests need to include `X-Cortex-Project` header in requests.\n\n## Endpoints Affected\n\n| Endpoint | Change |\n|----------|--------|\n| `GET /health` | No change |\n| `GET /tickets` | Requires `X-Cortex-Project` header |\n| `POST /tickets` | Requires `X-Cortex-Project` header |\n| `GET /tickets/{status}` | Requires `X-Cortex-Project` header |\n| `GET /tickets/{status}/{id}` | Requires `X-Cortex-Project` header |\n| `PUT /tickets/{status}/{id}` | Requires `X-Cortex-Project` header |\n| `DELETE /tickets/{status}/{id}` | Requires `X-Cortex-Project` header |\n| `POST /tickets/{status}/{id}/move` | Requires `X-Cortex-Project` header |\n| `POST /tickets/{status}/{id}/spawn` | Requires `X-Cortex-Project` header |\n| `DELETE /sessions/{id}` | Requires `X-Cortex-Project` header |\n\n## Verification\n\n```bash\n# Start daemon (no project context needed)\ncortexd serve\n\n# From project directory, kanban should show project-local tickets\ncd ~/projects/test-cortex\ncortex kanban\n\n# From different project, should show different tickets\ncd ~/projects/other-project\ncortex kanban\n\n# API without header should fail\ncurl http://localhost:4200/tickets\n# Returns: {\"error\":\"missing X-Cortex-Project header\"}\n\n# API with header should work\ncurl -H \"X-Cortex-Project: /Users/me/projects/test-cortex\" http://localhost:4200/tickets\n\n# Run tests\nmake test\nmake test-integration\n```\n\n## Notes\n\n- The daemon no longer needs a \"current project\" - it serves any project\n- Store manager caches stores for performance (don't recreate on every request)\n- Project path must be absolute (validate in middleware)\n- Consider adding project path validation (must have `.cortex/tickets` directory)\n\n## Implementation\n\n### Commits Pushed\n\n- `4ca33e0` feat: make HTTP API project-aware via X-Cortex-Project header\n\n### Key Files Changed\n\n| File | Change |\n|------|--------|\n| `internal/daemon/api/store_manager.go` | **NEW** - Thread-safe per-project store manager with lazy initialization |\n| `internal/daemon/api/middleware.go` | Added `ProjectRequired()` middleware to validate header |\n| `internal/daemon/api/deps.go` | Replaced `TicketStore`, `ProjectConfig`, `ProjectRoot` with `StoreManager` |\n| `internal/daemon/api/server.go` | Applied middleware to project-scoped routes (all except `/health`) |\n| `internal/daemon/api/tickets.go` | All handlers get store from context via `GetProjectPath()` + `StoreManager.GetStore()` |\n| `internal/daemon/api/sessions.go` | Handler gets store from context, loads project config per-request |\n| `cmd/cortexd/commands/serve.go` | Removed global ticket store init, creates `StoreManager` instead |\n| `internal/cli/sdk/client.go` | Added `projectPath` field and `doRequest()` helper to add header |\n| `cmd/cortex/commands/kanban.go` | Added `resolveProjectPath()` helper, passes project to client |\n| `cmd/cortex/commands/list.go` | Uses `resolveProjectPath()` |\n| `cmd/cortex/commands/spawn.go` | Uses `resolveProjectPath()` |\n| `cmd/cortex/commands/session.go` | Uses `resolveProjectPath()` |\n| `cmd/cortex/commands/version.go` | Passes empty string for health check (doesn't need project) |\n| `internal/daemon/api/integration_test.go` | Updated to use `StoreManager`, adds header to requests, new validation tests |\n\n### Important Decisions\n\n1. **Middleware validates three things**: header presence, absolute path, and `.cortex/tickets` directory existence\n2. **StoreManager uses double-check locking**: fast read path for cached stores, thread-safe creation for new ones\n3. **Spawn handler loads project config per-request**: since config is now project-specific, it's loaded on demand\n4. **Health endpoint excluded from middleware**: allows daemon health checks without project context\n5. **`resolveProjectPath()` defined in kanban.go**: shared helper available to all CLI commands in the same package\n\n### Scope Changes\n\nNone - implementation followed the original ticket specification.",
  "dates": {
    "created": "2026-01-21T16:26:53Z",
    "updated": "2026-01-21T16:26:53Z",
    "done": "2026-01-21T16:26:53Z"
  },
  "comments": [],
  "session": null
}
