{
  "id": "835996c0-24c0-456e-afa0-6b77ef10d65d",
  "title": "Agent Status Tracking",
  "body": "## Context\n\nEarly development, no users. Breaking changes are fine. Do not accumulate tech debt.\n\n## Problem\n\nNo visibility into what agents are currently doing. Kanban shows tickets but not agent activity (thinking, running tool, idle, waiting for permission).\n\n## Requirements\n\n### 1. Generate settings.json per spawn\n\nWhen spawning agents, generate a settings.json alongside mcp-config.json:\n\n```json\n{\n  \"hooks\": {\n    \"PostToolUse\": [{\n      \"matcher\": \"*\",\n      \"hooks\": [{\"type\": \"command\", \"command\": \"cortexd hook post-tool-use\"}]\n    }],\n    \"Stop\": [{\n      \"hooks\": [{\"type\": \"command\", \"command\": \"cortexd hook stop\"}]\n    }],\n    \"PermissionRequest\": [{\n      \"hooks\": [{\"type\": \"command\", \"command\": \"cortexd hook permission-request\"}]\n    }]\n  }\n}\n```\n\n### 2. Update spawn command\n\nAdd `--settings <path>` to claude command:\n\n```bash\nCORTEX_TICKET_ID=<id> CORTEX_PROJECT=<path> claude '<prompt>' --mcp-config <path> --settings <path>\n```\n\n### 3. Add `cortexd hook` subcommand\n\nHandles hook events from claude:\n\n```bash\ncortexd hook post-tool-use   # reads JSON from stdin\ncortexd hook stop\ncortexd hook permission-request\n```\n\nEach command:\n- Reads `CORTEX_TICKET_ID` and `CORTEX_PROJECT` from env\n- Reads hook JSON from stdin (claude provides tool info)\n- POSTs to daemon API\n\n### 4. Add API endpoint\n\n```\nPOST /agent/status\nX-Cortex-Project: /path/to/project\n\n{\n  \"ticket_id\": \"abc123\",\n  \"status\": \"in_progress\",\n  \"tool\": \"Bash\",\n  \"work\": \"Running tests...\"\n}\n```\n\nUpdates `CurrentStatus` and appends to `StatusHistory` on the ticket's session.\n\n### 5. Display in kanban\n\nShow current status on ticket cards (e.g., \"thinking...\", \"Bash: running tests\").\n\n## Implementation\n\n### Commits Pushed\n- `32d7152` feat: add agent status tracking via Claude hooks\n- `6578828` Merge branch 'ticket/2026-01-22-agent-status-tracking'\n\n### Key Files Changed\n\n**Created:**\n- `internal/core/spawn/settings.go` - Generates Claude settings.json with hooks config\n- `internal/daemon/api/agent.go` - POST /agent/status API handler\n- `cmd/cortexd/commands/hook.go` - Hook subcommands (post-tool-use, stop, permission-request)\n\n**Modified:**\n- `internal/core/spawn/command.go` - Added SettingsPath field and --settings flag\n- `internal/core/spawn/spawn.go` - Integrated settings generation, added CORTEX_PROJECT env var\n- `internal/daemon/api/types.go` - Added AgentStatus/AgentTool to TicketSummary\n- `internal/daemon/api/server.go` - Added /agent/status route\n- `internal/cli/sdk/client.go` - Added AgentStatus/AgentTool fields\n- `internal/cli/tui/kanban/column.go` - Added formatAgentStatus() with status symbols\n\n### Important Decisions\n- Hook commands fail gracefully (exit 0) if env vars missing or daemon unreachable\n- Status symbols: \u25b6 starting, \u25cf in_progress, \u25cb idle, \u23f8 waiting_permission, \u2717 error\n- Tool names truncated to 8 chars in kanban display\n- CORTEX_PROJECT env var added alongside CORTEX_TICKET_ID for hooks\n\n### Scope Changes\n- None - implemented as specified",
  "dates": {
    "created": "2026-01-24T09:43:49Z",
    "updated": "2026-01-24T09:43:49Z",
    "done": "2026-01-24T09:43:49Z"
  },
  "comments": [],
  "session": null
}
