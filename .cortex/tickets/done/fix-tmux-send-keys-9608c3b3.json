{
  "id": "9608c3b3-8305-40f7-b45c-ec494f768590",
  "title": "Fix tmux send-keys Command Too Long",
  "body": "## Context\n\nEarly development, no users. Breaking changes are fine. Do not accumulate tech debt.\n\n## Problem\n\n`cortex architect` fails with:\n\n```\nfailed to spawn agent in tmux: tmux command failed: send-keys: command too long\n```\n\nThe full claude command (prompt + system prompt + flags) is passed as a single argument to tmux `send-keys`. With many tickets, the prompt alone can exceed tmux's ~4KB buffer limit. POSIX shell escaping (single quote \u2192 `'\\''`) makes it worse by roughly doubling size.\n\nThe chain:\n1. `internal/core/spawn/spawn.go` builds architect prompt with full ticket list inline\n2. `internal/core/spawn/command.go` embeds prompt + system prompt as inline arguments in the claude command string\n3. `internal/tmux/command.go:20` passes the entire string to `send-keys` as one argument\n\nThe two largest contributors are:\n- The ticket list prompt (scales with project size)\n- The system prompt from `--append-system-prompt`\n\n## Requirements\n\n- Prompts and system prompts must not be passed inline in the tmux send-keys command\n- Write prompt content to temporary files and use file-based arguments instead (e.g., `cat file | claude --append-system-prompt ...` or similar)\n- Must work for both architect and ticket agent spawns\n- Clean up temp files when session ends\n\n## Implementation\n\n### Commits\n\n- `f3f9876` fix: replace inline prompt embedding with launcher script for tmux send-keys\n\n### Key files changed\n\n- **Created** `internal/core/spawn/prompt_file.go` \u2014 `WritePromptFile`/`RemovePromptFile` for writing prompt content to temp files\n- **Created** `internal/core/spawn/launcher.go` \u2014 `WriteLauncherScript` generates a bash launcher that uses `$(cat file)` to read prompts at runtime; includes `trap EXIT` to clean up all temp files\n- **Modified** `internal/core/spawn/command.go` \u2014 Removed `BuildClaudeCommand`, `ClaudeCommandParams`, `EscapePromptForShell` (replaced by launcher)\n- **Modified** `internal/core/spawn/spawn.go` \u2014 `Spawn()` and `Resume()` now write prompt files, generate a launcher script, and pass `bash /path/launcher.sh` (~50 bytes) to tmux instead of the full inline command; `cleanupOnFailure()` changed to accept `tempFiles []string`\n- **Modified** `internal/core/spawn/spawn_test.go` \u2014 Replaced old command-building tests with launcher script tests; updated spawn/resume integration tests to verify launcher usage\n\n### Decisions\n\n- **`$(cat file)` in double quotes** is safe \u2014 parameter expansion is not re-interpreted by bash, so prompt content with backticks, `$`, or quotes is passed verbatim to claude\n- **`trap EXIT`** handles cleanup for all exit paths \u2014 normal exit, error, SIGHUP from tmux kill-window. This also cleans up MCP and settings config files, which were previously leaked on normal session completion\n- **Removed dead code** (`BuildClaudeCommand`, `EscapePromptForShell`) rather than keeping backward compatibility \u2014 per ticket guidance on no tech debt\n\n### Scope changes\n\nNone \u2014 implemented as specified",
  "dates": {
    "created": "2026-01-26T10:05:26Z",
    "updated": "2026-01-26T10:05:26Z",
    "done": "2026-01-26T10:05:26Z"
  },
  "comments": [],
  "session": null
}
