{
  "id": "a7ff0b61-0198-4825-be66-0e73d1a2313e",
  "title": "MCP Integration",
  "body": "Wire lifecycle hooks and session spawning into MCP tools.\n\n## Context\n\nThe MCP server has all tools implemented but some are stubbed or missing hook integration. The lifecycle, tmux, and project config packages are ready but not connected.\n\nSee `DESIGN.md` for:\n- MCP tools behavior (lines 171-202)\n- Hook execution on tools (lines 188-192)\n- Agent spawning (lines 356-378)\n- MCP config format (lines 383-396)\n\nExisting packages to integrate:\n- `internal/lifecycle` - hook execution\n- `internal/tmux` - session management\n- `internal/project/config` - load hook definitions\n- `internal/git` - get git_base for sessions\n\n## Requirements\n\nUpdate `internal/daemon/mcp/` to:\n\n1. **Load Project Config**\n   - Use `project/config.LoadFromPath()` at server init\n   - Make hook definitions available to tools\n\n2. **Wire pickupTicket**\n   - Execute `on_pickup` hooks after marking ticket in progress\n   - Pass template variables (ticket_id, ticket_slug, ticket_title)\n   - Return hook results in response\n\n3. **Wire submitReport**\n   - Execute `on_submit` hooks after updating report\n   - Return hook results (success/failure, stdout)\n\n4. **Wire approve**\n   - Execute `on_approve` hooks with commit_message\n   - Only move to done if hooks succeed\n   - Return hook results\n\n5. **Wire spawnSession**\n   - Create tmux window using `internal/tmux`\n   - Generate MCP config file for the session\n   - Run `claude --mcp-config <path> --prompt <ticket-content>`\n   - Record git_base using `internal/git`\n   - Add session to ticket\n\n## Verification\n\n```bash\nmake build   # Builds successfully\nmake test    # Tests pass\nmake lint    # No lint errors\n\n# Manual test with cortexd mcp\necho '{\"method\":\"listTickets\"}' | cortexd mcp\n```\n\n## Notes\n\n- Hook failures should return error to agent, not crash\n- Template variable errors should be reported clearly\n- spawnSession creates detached tmux window (agent runs independently)\n- MCP config should use CORTEX_TICKET_ID env var\n\n## Implementation\n\n### Commits Pushed\n- `3a17039` feat: integrate lifecycle hooks and implement spawnSession in MCP tools\n\n### Key Files Changed\n- `internal/daemon/mcp/server.go` - Extended Config with ProjectPath/TmuxSession, added projectConfig and lifecycle executor\n- `internal/daemon/mcp/types.go` - Added HookResultOutput, HooksExecutionOutput, updated output types with Hooks field\n- `internal/daemon/mcp/helpers.go` - New file with hook conversion utilities (convertHookConfigs, buildTemplateVars, getHooksForType, convertExecutionResult)\n- `internal/daemon/mcp/tools_ticket.go` - Wired on_pickup, on_submit, on_approve hooks into handlers\n- `internal/daemon/mcp/tools_architect.go` - Full spawnSession implementation with tmux/MCP config generation\n- `internal/daemon/mcp/tools_test.go` - Updated and added tests for spawnSession\n\n### Important Decisions\n1. **Hook failure behavior**: on_pickup and on_submit hooks log failures but don't fail the operation; on_approve hooks must succeed before moving ticket to done\n2. **Permission mode**: Uses `--permission-mode plan` for ticket sessions (following cortex0 pattern for controlled execution)\n3. **MCP config location**: Generated at `/tmp/cortex-mcp-{ticket_id}.json` with cortexd command and environment variables\n4. **Prompt format**: Passes ticket title and body as positional argument to claude, instructs agent to use cortex MCP tools\n\n### Scope Changes\n- Original ticket mentioned `--prompt` flag for claude, but claude CLI uses positional argument for prompts (fixed during implementation)\n- Added `--permission-mode plan` based on comparison with cortex0 approach (not in original requirements)",
  "dates": {
    "created": "2026-01-20T14:16:36Z",
    "updated": "2026-01-20T14:16:36Z",
    "done": "2026-01-20T14:16:36Z"
  },
  "comments": [],
  "session": null
}
