{
  "id": "f3682ff0-9bd4-4ddf-82e7-3575001b25d4",
  "title": "API Integration Tests",
  "body": "Add integration tests for HTTP API endpoints using `httptest`.\n\n## Context\n\nThe daemon exposes REST endpoints for ticket management. We need integration tests that test the full HTTP flow (routing, handlers, JSON encoding) against a real file-based ticket store.\n\n## Endpoints to Test\n\n| Endpoint | Method | Test Cases |\n|----------|--------|------------|\n| `/health` | GET | Returns status ok |\n| `/tickets` | GET | Empty list; list with tickets |\n| `/tickets` | POST | Create ticket; invalid JSON |\n| `/tickets/{status}` | GET | List by status; invalid status |\n| `/tickets/{status}/{id}` | GET | Get ticket; not found; wrong status |\n| `/tickets/{status}/{id}` | PUT | Update ticket; not found |\n| `/tickets/{status}/{id}` | DELETE | Delete ticket; not found |\n| `/tickets/{status}/{id}/move` | POST | Move ticket; invalid target status |\n\n## Endpoints to Skip\n\nThese use tmux and should be skipped:\n- `POST /tickets/{status}/{id}/spawn`\n- `DELETE /sessions/{id}`\n\n## Requirements\n\n### 1. Expose Router for Testing\n\nUpdate `internal/daemon/api/server.go` to export a `NewRouter(deps)` function:\n\n```go\nfunc NewRouter(deps *Dependencies) chi.Router {\n    r := chi.NewRouter()\n    // ... existing route setup ...\n    return r\n}\n\nfunc NewServer(port int, logger *slog.Logger, deps *Dependencies) *Server {\n    r := NewRouter(deps)\n    // ... rest of server setup ...\n}\n```\n\n### 2. Create Integration Test File\n\nCreate `internal/daemon/api/integration_test.go` with build tag:\n\n```go\n//go:build integration\n```\n\n### 3. Test Setup Helper\n\n```go\nfunc setupTestServer(t *testing.T) *httptest.Server {\n    tmpDir := t.TempDir()\n\n    // Create .cortex structure\n    for _, dir := range []string{\"backlog\", \"progress\", \"done\"} {\n        os.MkdirAll(filepath.Join(tmpDir, \".cortex/tickets\", dir), 0755)\n    }\n\n    store := ticket.NewStore(filepath.Join(tmpDir, \".cortex/tickets\"))\n    deps := &Dependencies{\n        TicketStore:   store,\n        TmuxManager:   nil,\n        ProjectConfig: &projectconfig.Config{Name: \"test\"},\n        Logger:        slog.New(slog.NewTextHandler(io.Discard, nil)),\n        ProjectRoot:   tmpDir,\n    }\n\n    return httptest.NewServer(NewRouter(deps))\n}\n```\n\n### 4. Test Cases to Implement\n\n- `TestHealthEndpoint`\n- `TestListAllTicketsEmpty`\n- `TestListAllTicketsWithData`\n- `TestCreateTicket`\n- `TestCreateTicketInvalidJSON`\n- `TestGetTicket`\n- `TestGetTicketNotFound`\n- `TestGetTicketWrongStatus`\n- `TestUpdateTicket`\n- `TestDeleteTicket`\n- `TestMoveTicket`\n- `TestMoveTicketInvalidStatus`\n- `TestListByStatus`\n- `TestInvalidStatus`\n\n### 5. Update Makefile\n\nAdd to Makefile:\n\n```makefile\ntest-integration:\n\tgo test -tags=integration -v ./internal/daemon/api/... ./internal/daemon/mcp/...\n```\n\n## Verification\n\n```bash\nmake test              # Unit tests only\nmake test-integration  # Integration tests\n```\n\n## Notes\n\n- Use `t.TempDir()` for automatic cleanup\n- Discard logger output in tests\n- Test both success and error paths\n- Verify response status codes and JSON bodies\n\n## Implementation\n\n### Commits Pushed\n\n- `9949c59` feat: add API integration tests with httptest\n\n### Key Files Changed\n\n| File | Change |\n|------|--------|\n| `internal/daemon/api/server.go` | Extracted route setup into `NewRouter()` function |\n| `internal/daemon/api/integration_test.go` | New file with 14 integration tests |\n| `Makefile` | Added API tests to `test-integration` target |\n\n### Important Decisions\n\n- Used `httptest.NewServer` for in-process HTTP testing (no binary required)\n- Tests use real `ticket.Store` with temporary directories for realistic integration\n- Skipped spawn and session kill endpoints as they require tmux\n\n### Scope Changes\n\nNone - implemented all 14 test cases as specified in the requirements.",
  "dates": {
    "created": "2026-01-21T14:23:36Z",
    "updated": "2026-01-21T14:23:36Z",
    "done": "2026-01-21T14:23:36Z"
  },
  "comments": [],
  "session": null
}
