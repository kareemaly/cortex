{
  "id": "bc45c4b9-ec64-4f91-83ae-4444e11b668c",
  "type": "work",
  "title": "Notification Infrastructure: Config Schema + Tmux Attachment Detection",
  "body": "# Overview\n\nAdd the foundational infrastructure for the notification system: configuration schema and tmux user attachment detection.\n\n## 1. Notification Config Schema\n\nAdd `notifications` section to global settings (`~/.cortex/settings.yaml`).\n\n**Location:** `internal/daemon/config/config.go`\n\n```yaml\nnotifications:\n  channels:\n    local:\n      enabled: true                    # Default: true\n      sound: true                      # Play sound with notification\n      \n  behavior:\n    batch_window_seconds: 60           # Collect events before sending\n    notify_on_first_only: true         # Only notify on 0→N transition\n    reminder_after_minutes: 10         # Re-nudge if still waiting (0 = disabled)\n    suppress_when_attached: true       # Skip notification if user is in that tmux session\n    \n  events:\n    agent_waiting_permission: true     # Plan approval needed\n    agent_idle: true                   # Agent finished working\n    agent_error: true                  # Agent hit error state\n    ticket_review_requested: true      # Agent called requestReview\n```\n\n**Requirements:**\n- Add `NotificationsConfig` struct with nested `ChannelsConfig`, `BehaviorConfig`, `EventsConfig`\n- Set sensible defaults (local enabled, others as shown above)\n- Load and validate on daemon startup\n- Unit tests for config loading and defaults\n\n## 2. Tmux Client Attachment Detection\n\nExtend tmux manager to detect if a user is attached to a session/window.\n\n**Location:** `internal/tmux/`\n\n**New methods:**\n- `ListClients(session string) ([]Client, error)` — wraps `tmux list-clients -t SESSION`\n- `IsUserAttached(session, windowName string) bool` — returns true if any client is viewing the specified window\n\n**Client struct:**\n```go\ntype Client struct {\n    TTY         string  // e.g., /dev/ttys001\n    Session     string  // Session name\n    Window      int     // Active window index\n    WindowName  string  // Active window name (if available)\n}\n```\n\n**Requirements:**\n- Parse `tmux list-clients -t SESSION -F \"#{client_tty}:#{window_index}:#{window_name}\"` output\n- Handle case where no clients attached (empty list, not error)\n- Unit tests with mocked tmux output\n\n## Files to Modify/Create\n\n- `internal/daemon/config/config.go` — add NotificationsConfig\n- `internal/daemon/config/config_test.go` — test config loading\n- `internal/tmux/client.go` (new) — Client struct and ListClients\n- `internal/tmux/manager.go` — add IsUserAttached helper\n- `internal/tmux/client_test.go` (new) — unit tests\n\n## Out of Scope\n\n- Notification dispatcher logic (Ticket C)\n- Notification channel implementations (Ticket B)\n- Actually sending notifications",
  "dates": {
    "created": "2026-02-04T07:27:46.753844Z",
    "updated": "2026-02-04T07:39:35.056592Z",
    "progress": "2026-02-04T07:27:52.864303Z",
    "reviewed": "2026-02-04T07:38:44.366003Z",
    "done": "2026-02-04T07:39:35.056592Z"
  },
  "comments": [
    {
      "id": "11f2f7f5-9030-41b2-8379-291d6db6ed15",
      "session_id": "60943293-2fca-451a-8ada-e15ff76dc459",
      "type": "review_requested",
      "content": "## Summary\n\nAdded foundational notification infrastructure with two components:\n\n### 1. Notification Config Schema (`internal/daemon/config/config.go`)\n\nAdded nested config structs for notification settings in global `settings.yaml`:\n\n- **LocalChannelConfig**: Desktop notification settings (enabled, sound)\n- **ChannelsConfig**: Container for channel configs (extensible for future channels)\n- **BehaviorConfig**: Timing and batching settings\n  - `batch_window_seconds: 60` - Batch notifications within window\n  - `notify_on_first_only: true` - Only notify on first event in batch\n  - `reminder_after_minutes: 10` - Reminder for unaddressed events\n  - `suppress_when_attached: true` - Suppress if user viewing window\n- **EventsConfig**: Which events trigger notifications (all default to true)\n  - `agent_waiting_permission`\n  - `agent_idle`\n  - `agent_error`\n  - `ticket_review_requested`\n- **NotificationsConfig**: Top-level container\n\nAll defaults are set in `DefaultConfig()` and tested for round-trip persistence.\n\n### 2. Tmux Client Attachment Detection (`internal/tmux/client.go`)\n\nAdded methods to the existing `Manager` type:\n\n- **ListClients(session)**: Returns all attached clients with TTY, session, window index, and window name. Handles colons in window names with `SplitN(..., 4)`.\n- **IsUserAttached(session, windowName)**: Returns true if any client is viewing the specified window by name.\n- **IsUserAttachedToWindow(session, windowIndex)**: Same but matches by index.\n\nBoth `IsUserAttached*` methods return `false` on error (safe default for notifications - don't suppress if we can't determine attachment).\n\n### Tests Added\n\n- `TestDefaultConfigNotifications` - Verify all default values\n- `TestNotificationsConfigRoundTrip` - Save/load with modified values\n- `TestNotificationsPartialYAML` - Partial YAML preserves defaults for unset fields\n- 11 tests for tmux client detection covering parsing, empty output, session not found, colons in window names, and IsUserAttached behavior\n\n### Verification\n\n```\nmake test   # All 136 tests pass\nmake lint   # 0 issues\n```",
      "action": {
        "type": "git_diff",
        "args": {
          "commit": "6fd875b",
          "repo_path": "/Users/kareemelbahrawy/.cortex/worktrees/8daff18f-0b1f-41e0-b462-b08bd3d7ed39"
        }
      },
      "created_at": "2026-02-04T07:38:44.364772Z"
    },
    {
      "id": "8bfac018-0358-44bc-ba7c-0f752e8171b2",
      "session_id": "60943293-2fca-451a-8ada-e15ff76dc459",
      "type": "done",
      "content": "## Notification Infrastructure: Config Schema + Tmux Attachment Detection\n\n### Changes Made\n\n**1. Notification Config Schema** (`internal/daemon/config/config.go`)\nAdded nested configuration structs for notification settings in global `settings.yaml`:\n\n- `LocalChannelConfig`: Desktop notification settings (enabled, sound)\n- `ChannelsConfig`: Container for channel configs (extensible for future channels like Slack, SMS)\n- `BehaviorConfig`: Timing and batching settings\n  - `batch_window_seconds: 60`\n  - `notify_on_first_only: true`\n  - `reminder_after_minutes: 10`\n  - `suppress_when_attached: true`\n- `EventsConfig`: Which events trigger notifications\n  - `agent_waiting_permission: true`\n  - `agent_idle: true`\n  - `agent_error: true`\n  - `ticket_review_requested: true`\n- `NotificationsConfig`: Top-level container added to main `Config` struct\n\nAll defaults set in `DefaultConfig()`.\n\n**2. Tmux Client Attachment Detection** (`internal/tmux/client.go`)\nAdded methods to existing `Manager` type:\n\n- `ListClients(session)`: Returns all attached clients with TTY, session, window index, window name\n- `IsUserAttached(session, windowName)`: Check if user viewing window by name\n- `IsUserAttachedToWindow(session, windowIndex)`: Check by window index\n- Both return `false` on error (safe default - don't suppress notifications if detection fails)\n\n### Files Changed\n- `internal/daemon/config/config.go` - Added 5 struct types + Notifications field\n- `internal/daemon/config/config_test.go` - Added 3 tests for config behavior\n- `internal/tmux/client.go` - New file with Client struct and methods\n- `internal/tmux/client_test.go` - New file with 11 unit tests\n\n### Verification\n- All 136 tests pass (`make test`)\n- Linter clean (`make lint` - 0 issues)\n\n### Merge\nBranch `ticket/notification` merged to main and pushed to origin.",
      "created_at": "2026-02-04T07:39:35.054576Z"
    }
  ],
  "session": {
    "id": "60943293-2fca-451a-8ada-e15ff76dc459",
    "started_at": "2026-02-04T07:27:52.798196Z",
    "ended_at": "2026-02-04T07:39:35.055638Z",
    "agent": "claude",
    "tmux_window": "notification-infrastructure-config-schema-tmux-att",
    "worktree_path": "/Users/kareemelbahrawy/.cortex/worktrees/8daff18f-0b1f-41e0-b462-b08bd3d7ed39",
    "feature_branch": "ticket/notification",
    "current_status": {
      "status": "in_progress",
      "tool": "Bash",
      "work": null,
      "at": "2026-02-04T07:39:21.859204Z"
    },
    "status_history": [
      {
        "status": "starting",
        "tool": null,
        "work": null,
        "at": "2026-02-04T07:27:52.798196Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-02-04T07:28:48.066676Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-02-04T07:28:48.622896Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:28:49.064351Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:51.208517Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:51.209574Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:51.485136Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:51.486304Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:51.486805Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:28:54.663908Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-02-04T07:28:54.945201Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:55.967449Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:55.968979Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:55.972108Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:57.044881Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:59.452153Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:59.453219Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:28:59.453802Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:29:00.550584Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:29:00.555281Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:02.258491Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:03.022924Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:29:05.359215Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:29:07.397965Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-02-04T07:29:18.157278Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-02-04T07:29:19.500744Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:30.452677Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:30.453751Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:30.454472Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:37.985706Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:29:37.98667Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:05.930396Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:05.931573Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:30:10.849933Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-02-04T07:30:11.201842Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:15.814331Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:15.815312Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:15.816071Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:15.816875Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:24.134765Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:24.136051Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:24.13733Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:30:31.556688Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:30:31.93236Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:30:37.360012Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-02-04T07:31:57.407288Z"
      },
      {
        "status": "in_progress",
        "tool": "Write",
        "work": null,
        "at": "2026-02-04T07:32:23.614105Z"
      },
      {
        "status": "waiting_permission",
        "tool": null,
        "work": null,
        "at": "2026-02-04T07:32:29.243771Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:33:22.063022Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:26.968664Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:26.969985Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-02-04T07:33:31.284425Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:36.195018Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:36.196696Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:36.197866Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:42.431925Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:33:42.433436Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:33:48.899951Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-02-04T07:34:01.462856Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-02-04T07:34:07.501048Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:34:14.205584Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-02-04T07:34:24.254988Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:34:29.332801Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-02-04T07:34:52.543812Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:34:59.809029Z"
      },
      {
        "status": "in_progress",
        "tool": "Write",
        "work": null,
        "at": "2026-02-04T07:35:14.179334Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:35:22.201485Z"
      },
      {
        "status": "in_progress",
        "tool": "Write",
        "work": null,
        "at": "2026-02-04T07:35:57.974085Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:36:05.038795Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-02-04T07:36:19.548536Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-02-04T07:37:25.806459Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-02-04T07:37:35.953694Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:37:43.0154Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:37:48.135574Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:37:53.744338Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:38:02.567518Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-02-04T07:38:09.542941Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:38:15.684492Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:38:26.506896Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__requestReview",
        "work": null,
        "at": "2026-02-04T07:38:44.439524Z"
      },
      {
        "status": "idle",
        "tool": null,
        "work": null,
        "at": "2026-02-04T07:38:52.341724Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:39:15.072194Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-02-04T07:39:21.859204Z"
      }
    ]
  }
}