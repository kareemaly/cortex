{
  "id": "46af4347-4c5c-40b4-9ad6-62895762d04d",
  "title": "MCP Spawn Mode Support",
  "body": "Add mode parameter to MCP spawnSession tool for resume/fresh support.\n\n## Context\n\nThis is a fresh project with no users. No backward compatibility needed. Breaking changes are fine. Do not accumulate tech debt.\n\n## Dependencies\n\nRequires `2026-01-22-architect-session-state.md` to be completed first.\n\n## Changes to spawnSession\n\n### Input\n```go\ntype SpawnSessionInput struct {\n    TicketID string `json:\"ticket_id\"`\n    Agent    string `json:\"agent,omitempty\"`  // default: claude\n    Mode     string `json:\"mode,omitempty\"`   // normal (default), resume, fresh\n}\n```\n\n### Behavior\n\n| State | mode=normal | mode=resume | mode=fresh |\n|-------|-------------|-------------|------------|\n| Normal | spawn new | error | error |\n| Active | error (session in progress) | error | error |\n| Orphaned | error (must specify mode) | resume session | clear & spawn new |\n| Ended | spawn new | error | spawn new |\n\n### Output\nAdd state info to output:\n```go\ntype SpawnSessionOutput struct {\n    Success    bool\n    TicketID   string\n    SessionID  string\n    TmuxWindow string\n    State      string  // the detected state before action\n    Message    string\n}\n```\n\n## Optional: Architect Spawn Tool\n\nConsider adding `spawnArchitect` tool so architect can respawn itself after crash:\n```go\ntype SpawnArchitectInput struct {\n    Mode string `json:\"mode,omitempty\"` // normal, resume, fresh\n}\n```\n\nThis allows the architect to recover from orphaned state.\n\n## Verification\n\n```bash\nmake lint\nmake test\nmake build\nmake test-integration\n```\n\n## Implementation\n\n### Commits Pushed\n- `2ccf2ed` feat: add mode parameter to spawnSession for orphaned session handling\n- `7a5b113` Merge branch 'ticket/2026-01-22-mcp-spawn-mode'\n\n### Key Files Changed\n- `internal/daemon/mcp/types.go` - Added Mode to SpawnSessionInput, State to SpawnSessionOutput\n- `internal/daemon/mcp/errors.go` - Added ErrorCodeStateConflict and NewStateConflictError\n- `internal/daemon/mcp/tools_architect.go` - Implemented mode-aware handler with state/mode matrix\n- `internal/daemon/mcp/tools_test.go` - Added 13 tests covering all state/mode combinations\n- `internal/tmux/mock_runner.go` - Added SetWindowExists method for orphaned state testing\n\n### Important Decisions\n- Mode defaults to \"normal\" when not specified (backward compatible)\n- STATE_CONFLICT error includes both state and mode in message for clear diagnostics\n- State is always returned in output, even on error, for transparency\n\n### Scope Changes\n- Deferred spawnArchitect tool to separate task (has additional complexity around self-spawning semantics)",
  "dates": {
    "created": "2026-01-23T06:42:32Z",
    "updated": "2026-01-23T06:42:32Z",
    "done": "2026-01-23T06:42:32Z"
  },
  "comments": [],
  "session": null
}
