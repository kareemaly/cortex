{
  "id": "c99497a8-0291-417a-99fc-f2553b3712d1",
  "title": "Core Spawn Package",
  "body": "Create shared spawn logic used by both MCP tools and HTTP API handlers.\n\n## Context\n\nThis is a fresh project with no users. No backward compatibility needed. Breaking changes are fine. Do not accumulate tech debt.\n\n## Package Location\n\n`internal/core/spawn/`\n\n## Responsibilities\n\n### State Detection\n- Check if tmux window exists for a session\n- Determine session state: `Normal` (no session), `Active` (session + window), `Orphaned` (session but no window), `Ended` (session.EndedAt set)\n\n### Spawn Operations\n- `Spawn(req)` - create new session, generate MCP config, spawn tmux window\n- `Resume(req)` - resume orphaned session with `claude --resume {sessionID}`\n- `Fresh(req)` - clear existing session, spawn new one\n\n### Shared Logic (extract from current MCP tools)\n- MCP config JSON generation (currently in `tools_architect.go`)\n- Prompt template loading (use `internal/prompt/` package)\n- Shell escaping for prompts\n- Tmux window spawning\n- Session creation with `store.SetSession()`\n- Error cleanup/rollback on failure\n\n## Spawn Request\n\nShould support both architect and ticket agent spawning:\n- Architect: no ticket, uses architect.md prompt\n- Ticket Agent: has ticketID, uses ticket-agent.md prompt\n\n## Used By\n\n- `internal/daemon/mcp/tools_architect.go` - spawnSession tool\n- `internal/daemon/api/` - spawn endpoints (future ticket)\n- `cmd/cortex/commands/architect.go` - architect spawning (future ticket)\n\n## Verification\n\n```bash\nmake lint\nmake test\nmake build\nmake test-integration\n```\n\n## Implementation\n\n### Commits\n\n- `75e82f2` refactor: extract spawn logic into internal/core/spawn package\n\n### Key Files Changed\n\n**Created:**\n- `internal/core/spawn/errors.go` - Error types (StateError, ConfigError, TmuxError, BinaryNotFoundError, PromptError)\n- `internal/core/spawn/config.go` - MCP config generation (GenerateMCPConfig, WriteMCPConfig, RemoveMCPConfig)\n- `internal/core/spawn/command.go` - Claude command building (BuildClaudeCommand, EscapePromptForShell, GenerateWindowName)\n- `internal/core/spawn/state.go` - Session state detection (DetectTicketState, StateInfo with Normal/Active/Orphaned/Ended states)\n- `internal/core/spawn/spawn.go` - Spawner struct with Spawn, Resume, Fresh methods\n- `internal/core/spawn/spawn_test.go` - 17 unit tests covering all functionality\n\n**Modified:**\n- `internal/daemon/mcp/tools_architect.go` - Replaced ~150 lines of inline spawn logic with ~40 lines using the spawn package\n\n### Important Decisions\n\n- Used dependency injection via `StoreInterface` and `TmuxManagerInterface` for testability\n- Added `TicketID` field to `SpawnResult` for consistency with output types\n- State detection uses tmux `WindowExists` check to distinguish Active vs Orphaned sessions\n- Package exposes type-checking helpers (`IsStateError`, `IsTmuxError`, etc.) for error handling\n\n### Scope\n\nImplemented as specified. No scope changes from original ticket.",
  "dates": {
    "created": "2026-01-22T13:08:39Z",
    "updated": "2026-01-22T13:08:39Z",
    "done": "2026-01-22T13:08:39Z"
  },
  "comments": [],
  "session": null
}
