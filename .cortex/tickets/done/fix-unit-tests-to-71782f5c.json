{
  "id": "71782f5c-5c51-4666-9cb0-d45fc4894df0",
  "title": "Fix unit tests to not create real tmux sessions",
  "body": "`make test` should run pure unit tests without side effects. Tests should not create real tmux sessions or spawn actual agents.\n\n## Problem\n\nSome tests may be creating actual tmux sessions or attempting to run real commands, which:\n- Causes test pollution (leftover sessions)\n- Makes tests flaky (depends on tmux being installed)\n- Slows down test suite\n- Can interfere with user's running tmux sessions\n\n## Requirements\n\n1. **Audit existing tests**\n   - Check `internal/tmux/*_test.go` for real tmux calls\n   - Check `internal/daemon/mcp/*_test.go` for spawn operations\n   - Identify any tests that shell out to real commands\n\n2. **Mock external dependencies**\n   - Tmux operations should be mockable (interface-based)\n   - Agent spawning should be mocked in tests\n   - File system operations should use temp directories\n\n3. **Keep tests fast and isolated**\n   - No network calls\n   - No real process spawning\n   - No persistent state between tests\n\n4. **Consider integration test separation**\n   - If we need real tmux tests, separate them: `make test-integration`\n   - Unit tests (`make test`) should always be safe to run\n\n## Verification\n\n```bash\n# Kill any existing tmux sessions\ntmux kill-server 2>/dev/null || true\n\n# Run tests\nmake test\n\n# Verify no tmux sessions were created\ntmux list-sessions 2>&1 | grep -q \"no server running\" && echo \"PASS: No sessions created\"\n```\n\n## Notes\n\n- Tests should pass even if tmux is not installed\n- Consider using interfaces for tmux.Manager to enable mocking\n\n## Implementation\n\n### Commits Pushed\n\n- `891785d` fix: add TmuxRunner interface to prevent tests from creating real tmux sessions\n- `1ba5077` Merge branch 'ticket/2026-01-21-unit-tests-no-side-effects'\n\n### Key Files Changed\n\n- `internal/tmux/tmux.go` - Added `TmuxRunner` interface, `execRunner` default implementation, and `NewManagerWithRunner()` for dependency injection\n- `internal/tmux/session.go` - Updated `AttachSession()` to use runner instead of direct exec.Command\n- `internal/tmux/mock_runner.go` (new) - Created `MockRunner` test implementation with configurable callbacks\n- `internal/daemon/mcp/server.go` - Added `TmuxManager` field to `Config` and `Server` structs\n- `internal/daemon/mcp/tools_architect.go` - Updated `handleSpawnSession()` to use injected manager if available\n- `internal/daemon/mcp/tools_test.go` - Added `setupTestServerWithMockTmux()` helper and updated spawn session tests\n\n### Important Decisions\n\n- Followed existing pattern from `internal/lifecycle/hooks.go` which uses `CommandRunner` interface with `NewExecutorWithRunner()` for testing\n- The `TmuxRunner` interface has two methods: `Run()` for non-interactive commands and `RunInteractive()` for attach/switch operations\n- Mock runner returns sensible defaults (e.g., window index \"1\" for new-window, empty success for most operations)\n- Integration tests remain unchanged (`internal/tmux/integration_test.go` with `//go:build integration`)\n\n### Scope Changes\n\nNone - implemented as originally planned.",
  "dates": {
    "created": "2026-01-21T09:18:41Z",
    "updated": "2026-01-21T09:18:41Z",
    "done": "2026-01-21T09:18:41Z"
  },
  "comments": [],
  "session": null
}
