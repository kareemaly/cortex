{
  "id": "7cb887be-36e1-4bfd-83c3-9cd0adee76af",
  "title": "Daemon API Integration",
  "body": "Wire project config, lifecycle hooks, and session spawning into daemon HTTP API.\n\n## Context\n\nThe daemon API has ticket endpoints but spawn is stubbed and hooks aren't executed. The supporting packages are ready for integration.\n\nSee `DESIGN.md` for:\n- Daemon API endpoints (lines 399-418)\n- Spawn endpoint behavior (line 411)\n- Session endpoints (lines 415-416)\n\nExisting packages to integrate:\n- `internal/lifecycle` - hook execution\n- `internal/tmux` - session management\n- `internal/project/config` - load config and hooks\n- `internal/git` - get git_base for sessions\n\n## Requirements\n\nUpdate `internal/daemon/api/` and `cmd/cortexd/`:\n\n1. **Load Project Config at Startup**\n   - Detect project root from current directory or flag\n   - Load `.cortex/cortex.yaml` using project/config package\n   - Pass config to handlers that need it\n\n2. **Wire Spawn Endpoint**\n   - `POST /tickets/{status}/{id}/spawn`\n   - Create tmux window for ticket\n   - Generate MCP config file\n   - Run agent command in window\n   - Record session with git_base\n   - Move ticket to progress\n   - Return session info\n\n3. **Wire Kill Session Endpoint**\n   - `DELETE /sessions/{id}`\n   - Kill tmux window\n   - End session in ticket store\n   - Return success/failure\n\n4. **Hook Execution on Move** (optional)\n   - When moving to progress, consider on_pickup\n   - When moving to done, consider on_approve\n   - Or leave hooks to MCP tools only\n\n## Verification\n\n```bash\nmake build   # Builds successfully\nmake test    # Tests pass\nmake lint    # No lint errors\n\n# Manual test\ncortexd &\ncurl -X POST http://localhost:4200/tickets/backlog/{id}/spawn\n```\n\n## Notes\n\n- Spawn should work from any ticket status (usually backlog)\n- Session kill should be idempotent\n- Project path could be passed via flag or env var\n- Consider adding project path to config response\n\n## Implementation\n\n### Commits\n\n- `889a065` feat: wire project config and tmux into daemon API spawn/kill endpoints\n\n### Key Files Changed\n\n- `internal/daemon/api/deps.go` (new) - Dependencies struct centralizing handler dependencies\n- `cmd/cortexd/commands/serve.go` - Load project config, tmux manager, and lifecycle executor at startup\n- `internal/daemon/api/server.go` - Accept Dependencies instead of individual stores\n- `internal/daemon/api/tickets.go` - Implement Spawn handler with full workflow\n- `internal/daemon/api/sessions.go` - Implement Kill handler with session lookup\n- `internal/daemon/api/types.go` - Add SpawnResponse type\n\n### Key Decisions\n\n1. **Dependencies Struct**: Created centralized Dependencies struct to avoid passing many parameters to handlers\n2. **Graceful Degradation**: TmuxManager is nil if tmux not installed; Spawn returns 503 in this case\n3. **Project Config Fallback**: If no `.cortex` directory found, uses DefaultConfig with warning log\n4. **MCP Config**: Written to temp file with format `cortex-mcp-*.json`\n5. **Session Naming**: Tmux session uses project name (default: \"cortex\"), window uses slugified ticket title\n6. **Kill Idempotency**: Kill succeeds even if tmux window already closed; logs warning but doesn't fail\n\n### Scope Changes\n\n- Deferred lifecycle hook execution (on_pickup) to future work - the executor is initialized but hooks not wired into spawn flow yet",
  "dates": {
    "created": "2026-01-20T14:14:33Z",
    "updated": "2026-01-20T14:14:33Z",
    "done": "2026-01-20T14:14:33Z"
  },
  "comments": [],
  "session": null
}
