{
  "id": "04639105-a7b6-40d6-9f8f-52593800ca0b",
  "title": "Fix Dashboard Focus: Investigate Broken Focusing and Route Through Daemon API",
  "body": "## Summary\n\nFocusing a session from the dashboard TUI is currently broken. Investigate the root cause and ensure all focus operations go through the daemon HTTP API rather than direct tmux calls from the client.\n\n## Problems\n\n1. Focusing a session from the dashboard does not work correctly — needs investigation into what exactly fails (wrong tmux target, session not found, race condition, etc.)\n2. The focus path may be calling tmux directly from the CLI client rather than going through the daemon API, which violates the architecture principle that all clients communicate exclusively over HTTP\n\n## Investigation\n\n- Trace the focus flow from dashboard keypress (`F` key / `Enter` on session row) through to the actual tmux operation\n- Check `spawnArchitect()` and `focusTicket()` in the dashboard model\n- Check the SDK client methods these call\n- Verify whether the daemon API has proper focus/attach endpoints or if the client is shelling out to tmux directly\n- If no daemon endpoint exists for focusing, add one\n\n## Expected Outcome\n\n- Focusing a session from the dashboard reliably switches to the correct tmux window\n- All focus operations route through `cortexd` HTTP API — no direct tmux calls from the CLI/TUI client\n\n## Files to investigate\n- `internal/cli/tui/dashboard/model.go` — focus command handlers\n- `internal/cli/sdk/client.go` — SDK client methods\n- `internal/daemon/api/` — check for focus/attach endpoints\n- `internal/tmux/` — tmux manager used by daemon",
  "dates": {
    "created": "2026-01-27T13:00:29.161951Z",
    "updated": "2026-01-27T13:42:12.890464Z",
    "progress": "2026-01-27T13:15:22.587807Z",
    "reviewed": "2026-01-27T13:30:09.126454Z",
    "done": "2026-01-27T13:42:12.890464Z"
  },
  "comments": [
    {
      "id": "c632bb42-246e-4fdc-a920-124cb0b90a11",
      "session_id": "0a4d0acf-1ad8-4d05-b88e-c68fe19ecc8c",
      "type": "progress",
      "content": "Implemented the fix: added `SwitchClient` method to tmux Manager and called it after every `FocusWindow` in all 4 API handlers (Focus, Spawn already-active, Architect Spawn already-active, Approve). Updated mock runner and added unit test. Lint clean, all tests pass.",
      "created_at": "2026-01-27T13:30:09.024489Z"
    },
    {
      "id": "eff820a8-9be5-42e3-9469-cc4be5c3893a",
      "session_id": "0a4d0acf-1ad8-4d05-b88e-c68fe19ecc8c",
      "type": "ticket_done",
      "content": "## Summary\n\nFixed dashboard focus not working when switching to agent sessions from the `cortex start` TUI.\n\n### Root Cause\n\nThe dashboard runs in the `CortexDaemon` tmux session while project agents run in separate tmux sessions (named after the project). When focusing a session, the daemon called `tmux select-window -t project:N`, which selects the window within the project's session but does **not** switch the user's tmux client from `CortexDaemon` to `project`. The user sees nothing happen.\n\n### Fix\n\nAdded `tmux switch-client -t \u003csession\u003e` after every `select-window` call. When run without `-c` (no specific client target), tmux targets the most recently active client — which is the user's terminal, since they just pressed a key in the dashboard.\n\n### Key Decisions\n\n- **Non-fatal SwitchClient calls**: All `SwitchClient` calls log warnings on failure rather than returning errors. This ensures `select-window` still succeeds even if no tmux client is attached (e.g., daemon running headless).\n- **Non-interactive execution**: `SwitchClient` uses `m.run()` (not `RunInteractive`), making it safe for daemon-side execution without a TTY.\n- **No interface changes needed**: `SwitchClient` is only called from API handlers which use `*tmux.Manager` directly (via `deps.TmuxManager`), so no interface updates were required in `spawn.TmuxManagerInterface`.\n\n### Files Modified (6 files, +66/-2)\n\n1. **`internal/tmux/session.go`** — Added `SwitchClient(session string) error` method\n2. **`internal/daemon/api/tickets.go`** — Added `SwitchClient` after `FocusWindow` in Focus handler and Spawn already-active path\n3. **`internal/daemon/api/architect.go`** — Added `SwitchClient` after `FocusWindow` in architect Spawn already-active path\n4. **`internal/daemon/api/sessions.go`** — Added `SwitchClient` after `FocusWindow` in Approve handler\n5. **`internal/tmux/mock_runner.go`** — Added `\"switch-client\"` to recognized no-op commands in both mock configurations\n6. **`internal/tmux/tmux_test.go`** — Added `TestSwitchClient` with subtests for correct args and error propagation\n\n### Verification\n\n- `make lint` — 0 issues\n- `make test` — all tests pass including new `TestSwitchClient`\n- Merged to main via fast-forward",
      "created_at": "2026-01-27T13:42:12.88923Z"
    }
  ],
  "session": {
    "id": "0a4d0acf-1ad8-4d05-b88e-c68fe19ecc8c",
    "started_at": "2026-01-27T13:15:22.556935Z",
    "ended_at": "2026-01-27T13:42:12.889909Z",
    "agent": "claude",
    "tmux_window": "fix-dashboard-focus-investigate-broken-focusing-an",
    "worktree_path": "/Users/kareemelbahrawy/.cortex/worktrees/b281f6fc-3062-4d9c-9081-256892fa7790",
    "feature_branch": "ticket/fix-dashboard-focus",
    "current_status": {
      "status": "in_progress",
      "tool": "Bash",
      "work": null,
      "at": "2026-01-27T13:41:55.225765Z"
    },
    "status_history": [
      {
        "status": "starting",
        "tool": null,
        "work": null,
        "at": "2026-01-27T13:15:22.556935Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:03.831309Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:05.971953Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:06.124214Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:16:08.481898Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:08.819619Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:16:10.726712Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:11.845146Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:16:12.586252Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:13.984887Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:16:15.86659Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-01-27T13:16:52.682774Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-01-27T13:17:03.695484Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:17:54.955433Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:17:54.956988Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:17:54.957644Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:43.493082Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:43.493712Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-27T13:18:46.04793Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:18:46.179626Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-27T13:18:46.307321Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:48.724441Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:48.725219Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:48.725657Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:48.7262Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:51.711595Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:18:52.090488Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:54.157863Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:54.158583Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:18:57.010786Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-01-27T13:19:12.944756Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:08.176036Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:08.176556Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:21:08.736602Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:14.259497Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:14.260346Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:14.260757Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:20.211016Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:21:20.211514Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__readTicket",
        "work": null,
        "at": "2026-01-27T13:22:03.988954Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:04.078792Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:04.092031Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:04.09266Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:04.094507Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:04.095449Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:04.097981Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:33.923309Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-27T13:22:34.332106Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-27T13:22:34.474239Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:39.864006Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:39.864659Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:39.865284Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-27T13:22:40.228872Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:55.840819Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:55.841686Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:55.842191Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:22:55.842685Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:23:07.752544Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:23:07.753055Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:23:20.284883Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:23:20.285737Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:23:32.274068Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:23:32.410163Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:23:45.157359Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:23:51.436167Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-01-27T13:25:31.275416Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:25:37.170494Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-27T13:25:37.541505Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:25:41.263923Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:25:41.264725Z"
      },
      {
        "status": "in_progress",
        "tool": "Write",
        "work": null,
        "at": "2026-01-27T13:26:25.525511Z"
      },
      {
        "status": "waiting_permission",
        "tool": null,
        "work": null,
        "at": "2026-01-27T13:26:28.55366Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__readTicket",
        "work": null,
        "at": "2026-01-27T13:27:35.669226Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:27:35.71744Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:27:35.72Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:27:35.720676Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:27:42.674255Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:27:42.674999Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:27:42.675631Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-27T13:27:50.343277Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-27T13:27:59.224363Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-27T13:28:23.570476Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-27T13:28:23.639937Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-27T13:28:23.714977Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-27T13:28:23.791528Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-27T13:28:35.339119Z"
      },
      {
        "status": "in_progress",
        "tool": "Write",
        "work": null,
        "at": "2026-01-27T13:28:51.031299Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-27T13:29:02.879868Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-27T13:29:02.979393Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-27T13:29:07.452633Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-27T13:29:14.437077Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:19.787278Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:23.755886Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:29.71201Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:30.248624Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:34.408999Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-27T13:29:40.870027Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:41.04209Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:44.087124Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:29:52.460702Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__addTicketComment",
        "work": null,
        "at": "2026-01-27T13:30:09.059396Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__requestReview",
        "work": null,
        "at": "2026-01-27T13:30:09.148481Z"
      },
      {
        "status": "idle",
        "tool": null,
        "work": null,
        "at": "2026-01-27T13:30:15.277735Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:41:51.733895Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-27T13:41:55.225765Z"
      }
    ],
    "requested_reviews": [
      {
        "repo_path": "/Users/kareemelbahrawy/.cortex/worktrees/b281f6fc-3062-4d9c-9081-256892fa7790",
        "summary": "**Fix: Dashboard focus not switching tmux client to agent session**\n\nRoot cause: `select-window` selects a window within the target session but doesn't switch the user's tmux client from the dashboard session (`CortexDaemon`) to the project session. The user sees nothing happen.\n\n**Changes (6 files, +66/-2):**\n\n1. **`internal/tmux/session.go`** — Added `SwitchClient(session)` method that runs `tmux switch-client -t \u003csession\u003e` via `m.run()` (non-interactive, safe for daemon)\n\n2. **`internal/daemon/api/tickets.go`** — Added non-fatal `SwitchClient` after `FocusWindow` in:\n   - `Focus` handler (line ~543): ticket focus from dashboard\n   - `Spawn` handler already-active path (line ~365): re-spawn focuses existing session\n\n3. **`internal/daemon/api/architect.go`** — Added non-fatal `SwitchClient` after `FocusWindow` in architect spawn already-active path (line ~98)\n\n4. **`internal/daemon/api/sessions.go`** — Added non-fatal `SwitchClient` after `FocusWindow` in `Approve` handler (line ~187)\n\n5. **`internal/tmux/mock_runner.go`** — Added `\"switch-client\"` to recognized no-op commands in both `SetWindowExists` and `NewMockRunner`\n\n6. **`internal/tmux/tmux_test.go`** — Added `TestSwitchClient` with two subtests: verifies correct args passed, and error propagation\n\nAll `SwitchClient` calls are non-fatal (warn-logged on failure) so `select-window` still succeeds even if no tmux client is attached. `make lint` = 0 issues, `make test` = all pass.",
        "requested_at": "2026-01-27T13:30:09.125371Z"
      }
    ]
  }
}