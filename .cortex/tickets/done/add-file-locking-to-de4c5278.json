{
  "id": "de4c5278-6744-407a-8b2c-33189465885d",
  "title": "Add File Locking to Ticket Store",
  "body": "## Problem\n\nThe ticket store (`internal/ticket/store.go`) has no file locking. When multiple processes (e.g., concurrent `UpdateSessionStatus` calls from agent hooks) write to the same ticket JSON file simultaneously, the file can become corrupted.\n\n**Observed failure:** Extra closing braces (`}}}}`) appended to a ticket JSON file, causing `json.Unmarshal` to fail. This surfaced as a 500 error on `GET /tickets` and `POST /agent/status`, persisting across daemon restarts since the corruption is on disk.\n\nThe error was also masked by `handleTicketError` (`internal/daemon/api/errors.go:33`) which swallows non-typed errors as a generic `\"internal server error\"` — the actual unmarshal error message was lost.\n\n## Solution\n\nAdd file-level or per-ticket locking to the store to prevent concurrent writes from corrupting ticket data.\n\nOptions:\n1. **In-process sync.Mutex per ticket ID** — simplest, works since all writes go through the single daemon process\n2. **File-level flock** — protects against external writers too, more robust but more complex\n3. **Atomic writes** — write to temp file + rename, prevents partial writes but not concurrent read-modify-write races (need locking too)\n\nRecommended: Option 1 (per-ticket mutex) + Option 3 (atomic writes) for defense in depth.\n\n## Secondary Fix\n\nImprove `handleTicketError` to log the actual error message for untyped errors, rather than swallowing it silently. This will make future debugging easier.\n\n## Acceptance Criteria\n\n- [ ] Concurrent writes to the same ticket do not corrupt the JSON file\n- [ ] `handleTicketError` logs the actual error for untyped/internal errors\n- [ ] Existing tests pass\n- [ ] Add a test for concurrent write safety",
  "dates": {
    "created": "2026-01-26T15:58:01.456893Z",
    "updated": "2026-01-26T16:07:49.509835Z",
    "reviewed": "2026-01-26T16:07:04.504423Z",
    "done": "2026-01-26T16:07:49.509835Z"
  },
  "comments": [
    {
      "id": "f531055f-91af-4f22-a4b5-c94625ed6332",
      "session_id": "4b4ff9ee-1398-4bfe-bfef-38fb64bcd1a6",
      "type": "ticket_done",
      "content": "## Summary\n\nAdded per-ticket mutex locking and atomic writes to the ticket store to prevent concurrent write corruption, and improved error logging in the HTTP API error handler.\n\n## Problem\n\nConcurrent writes to the same ticket JSON file (e.g., simultaneous `UpdateSessionStatus` calls from agent hooks) could corrupt the file, producing invalid JSON (extra closing braces). The error was also masked by `handleTicketError` which silently swallowed untyped errors as a generic \"internal server error\" without logging the actual cause.\n\n## Changes Made\n\n### 1. `internal/ticket/store.go`\n- Added `locks sync.Map` field to `Store` struct (maps ticket ID → `*sync.Mutex`)\n- Added `ticketMu(id string) *sync.Mutex` helper using `LoadOrStore`\n- Added per-ticket mutex locking to all 9 write methods: `Create`, `Update`, `Delete`, `Move`, `SetSession`, `EndSession`, `UpdateSessionStatus`, `AddComment`, `AddReviewRequest`\n- In `Delete`, added `s.locks.Delete(id)` to clean up the mutex after file removal\n- Rewrote `save()` to use atomic writes: `os.CreateTemp` → write → close → `os.Rename` (temp file in same directory guarantees same-filesystem atomic rename)\n- Added `.tmp-` prefix filtering in `List()` to skip crash-orphaned temp files\n\n### 2. `internal/daemon/api/errors.go`\n- Added `*slog.Logger` parameter to `handleTicketError`\n- Added `logger.Error(\"internal ticket store error\", \"error\", err)` in the default case\n\n### 3. `internal/daemon/api/tickets.go`\n- Updated all 13 `handleTicketError` call sites to pass `h.deps.Logger`\n\n### 4. `internal/ticket/store_test.go`\n- Added `TestStoreConcurrentUpdates`: 10 goroutines × 10 updates to the same ticket, verifies ticket remains valid JSON\n- Added `TestStoreConcurrentAddComments`: 10 goroutines each adding a comment, verifies all 10 comments are present (no lost updates)\n\n## Key Decisions\n\n- **Per-ticket mutex (not global mutex)**: Allows concurrent writes to different tickets without contention, while serializing writes to the same ticket.\n- **sync.Map for mutex storage**: Lock-free reads for the common case; `LoadOrStore` is atomic and avoids the need for a separate initialization lock.\n- **Atomic writes via temp+rename**: Defense in depth — even if a process crashes mid-write, the target file is never left in a partial state. Temp files use `.tmp-` prefix and are in the same directory to guarantee same-filesystem rename.\n- **Read methods not locked**: `Get`, `List`, `ListAll` don't need locking because atomic writes ensure they always see complete files.\n\n## Verification\n\n- `make test` — all tests pass (including 2 new concurrency tests)\n- `make lint` — 0 issues\n- `make build` — compiles cleanly\n\n## Files Modified\n\n| File | Lines Changed |\n|------|--------------|\n| `internal/ticket/store.go` | +72 / -7 |\n| `internal/ticket/store_test.go` | +89 / -0 |\n| `internal/daemon/api/errors.go` | +4 / -2 |\n| `internal/daemon/api/tickets.go` | +13 / -13 |",
      "created_at": "2026-01-26T16:07:49.508265Z"
    }
  ],
  "session": {
    "id": "4b4ff9ee-1398-4bfe-bfef-38fb64bcd1a6",
    "started_at": "2026-01-26T15:58:52.196685Z",
    "ended_at": "2026-01-26T16:07:49.50899Z",
    "agent": "claude",
    "tmux_window": "add-file-locking-to-ticket-store",
    "current_status": {
      "status": "waiting_permission",
      "tool": null,
      "work": null,
      "at": "2026-01-26T16:07:48.585002Z"
    },
    "status_history": [
      {
        "status": "starting",
        "tool": null,
        "work": null,
        "at": "2026-01-26T15:58:52.196685Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__readTicket",
        "work": null,
        "at": "2026-01-26T15:58:59.870038Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T15:59:12.819616Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-26T15:59:13.196194Z"
      },
      {
        "status": "in_progress",
        "tool": "Glob",
        "work": null,
        "at": "2026-01-26T15:59:13.330577Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T15:59:13.677987Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T15:59:16.0144Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:21.01232Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:21.012615Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:21.01288Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:21.015251Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:26.943662Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:00:27.309849Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:00:27.440693Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:31.805243Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:31.806012Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:31.80736Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:37.641646Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:37.64205Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:00:37.976693Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:41.488361Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:00:46.678315Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:00:47.026965Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:00:52.532611Z"
      },
      {
        "status": "in_progress",
        "tool": "Task",
        "work": null,
        "at": "2026-01-26T16:02:24.132477Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:02:29.692937Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:02:36.87037Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:02:37.363129Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:02:37.492833Z"
      },
      {
        "status": "in_progress",
        "tool": "Write",
        "work": null,
        "at": "2026-01-26T16:03:02.190689Z"
      },
      {
        "status": "waiting_permission",
        "tool": null,
        "work": null,
        "at": "2026-01-26T16:03:04.703767Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__readTicket",
        "work": null,
        "at": "2026-01-26T16:03:12.15906Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:03:12.207232Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:03:12.211128Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:03:23.249499Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:03:23.285144Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:03:28.539611Z"
      },
      {
        "status": "in_progress",
        "tool": "Read",
        "work": null,
        "at": "2026-01-26T16:03:31.122087Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:03:36.447843Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:03:42.419006Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:03:47.224775Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:03:54.148982Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:03:59.179035Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:03.886294Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:08.967945Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:13.772869Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:18.989526Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:22.827039Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:27.204281Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:31.430906Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:37.202215Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:04:43.742513Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:04:53.973931Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:04:58.486106Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:05:02.79629Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:05:10.823449Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:05:15.224428Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:05:21.927462Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:05:27.408881Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:05:31.095083Z"
      },
      {
        "status": "in_progress",
        "tool": "Grep",
        "work": null,
        "at": "2026-01-26T16:05:36.376733Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:05:41.681492Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:05:46.967132Z"
      },
      {
        "status": "in_progress",
        "tool": "Edit",
        "work": null,
        "at": "2026-01-26T16:06:01.488846Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:06:07.441016Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:13.284689Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:19.677054Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:20.978784Z"
      },
      {
        "status": "in_progress",
        "tool": "TodoWrite",
        "work": null,
        "at": "2026-01-26T16:06:29.162456Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:39.720685Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:43.814225Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:46.773851Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:06:53.089669Z"
      },
      {
        "status": "in_progress",
        "tool": "mcp__cortex__requestReview",
        "work": null,
        "at": "2026-01-26T16:07:04.560715Z"
      },
      {
        "status": "idle",
        "tool": null,
        "work": null,
        "at": "2026-01-26T16:07:07.701184Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:07:23.802075Z"
      },
      {
        "status": "in_progress",
        "tool": "Bash",
        "work": null,
        "at": "2026-01-26T16:07:30.6983Z"
      },
      {
        "status": "waiting_permission",
        "tool": null,
        "work": null,
        "at": "2026-01-26T16:07:48.585002Z"
      }
    ],
    "requested_reviews": [
      {
        "repo_path": "/Users/kareemelbahrawy/projects/cortex1",
        "summary": "Added per-ticket mutex locking and atomic writes to the ticket store to prevent concurrent write corruption. Changes:\n\n1. **`internal/ticket/store.go`** — Added `sync.Map` field and `ticketMu()` helper to Store struct. All 9 write methods (Create, Update, Delete, Move, SetSession, EndSession, UpdateSessionStatus, AddComment, AddReviewRequest) now acquire per-ticket mutexes. Rewrote `save()` to use temp file + `os.Rename` for atomic writes. Added `.tmp-` prefix filtering in `List()` to handle crash-orphaned temp files.\n\n2. **`internal/daemon/api/errors.go`** — Added `*slog.Logger` parameter to `handleTicketError` and added `logger.Error()` call in the default case to log actual error details instead of silently swallowing them.\n\n3. **`internal/daemon/api/tickets.go`** — Updated all 13 `handleTicketError` call sites to pass `h.deps.Logger`.\n\n4. **`internal/ticket/store_test.go`** — Added `TestStoreConcurrentUpdates` (10 goroutines × 10 updates) and `TestStoreConcurrentAddComments` (10 goroutines each adding a comment, verifying all 10 are present).\n\nAll tests pass, lint clean, build succeeds.",
        "requested_at": "2026-01-26T16:07:04.503837Z"
      }
    ]
  }
}