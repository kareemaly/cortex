{
  "id": "7483a811-bdd0-4539-b01b-9ed2bc63a5e9",
  "title": "Fix cortexd path in MCP config generation",
  "body": "MCP config generation hardcodes `\"command\": \"cortexd\"` but cortexd may not be in PATH, causing MCP connection failures.\n\n## Symptoms\n\n- Claude shows \"MCP not connected\"\n- Claude hangs on startup waiting for MCP server\n- MCP server fails to start because `cortexd` command not found\n\n## Root Cause\n\nTwo locations hardcode the command:\n- `cmd/cortex/commands/architect.go:151` - `Command: \"cortexd\"`\n- `internal/daemon/mcp/tools_architect.go:369` - `Command: \"cortexd\"`\n\n## Requirements\n\n1. **Find cortexd binary path dynamically**\n   - Use `os.Executable()` to get the current binary path\n   - Derive cortexd path from cortex path (same directory)\n   - Example: if cortex is at `/Users/foo/.local/bin/cortex`, cortexd is at `/Users/foo/.local/bin/cortexd`\n\n2. **Update both MCP config generators**\n   - `cmd/cortex/commands/architect.go` - `generateArchitectMCPConfig()`\n   - `internal/daemon/mcp/tools_architect.go` - `spawnSession()`\n\n3. **Consider edge cases**\n   - When running from `go run` during development\n   - When binary name doesn't follow pattern (fallback to PATH lookup)\n\n## Verification\n\n```bash\nmake build\nmake lint\nmake test\n\n# Install to non-PATH location\ncp bin/cortex bin/cortexd ~/.local/bin/\n\n# Manual test (from tmux, after fixing nested session issue)\ncd ~/projects/test-cortex\ncortex architect\n# Should spawn with working MCP tools\n```\n\n## Notes\n\n- This is blocking MCP functionality for installed binaries\n- A helper function to find cortexd path could be shared between both locations\n\n## Implementation\n\n### Commits Pushed\n- `3badbb2` fix: use absolute path for cortexd in MCP config generation\n- `4e46f2b` Merge branch 'ticket/2026-01-21-mcp-config-cortexd-path'\n\n### Key Files Changed\n- `internal/binpath/binpath.go` (new) - Shared helper function `FindCortexd()` that derives cortexd path from current executable or falls back to PATH lookup\n- `cmd/cortex/commands/architect.go` - Updated `generateArchitectMCPConfig()` to use `binpath.FindCortexd()`\n- `internal/daemon/mcp/tools_architect.go` - Updated `handleSpawnSession()` to use `binpath.FindCortexd()` with proper error handling and session cleanup\n\n### Important Decisions\n- Created a shared `binpath` package rather than duplicating logic in both locations\n- Strategy: first check if running as cortex/cortexd and derive sibling path, then fall back to PATH lookup\n- Added session cleanup in `handleSpawnSession()` if cortexd lookup fails to avoid orphaned sessions\n\n### Scope Changes\n- None - implemented as specified in the plan",
  "dates": {
    "created": "2026-01-21T09:03:45Z",
    "updated": "2026-01-21T09:03:45Z",
    "done": "2026-01-21T09:03:45Z"
  },
  "comments": [],
  "session": null
}
