{
  "id": "5f5579e8-dee3-42f4-a83d-661b434a81d3",
  "title": "Ticket Workflow V2",
  "body": "## Context\n\nEarly development, no users. Breaking changes are fine. Do not accumulate tech debt.\n\n## Overview\n\nComplete overhaul of ticket agent workflow. Replace lifecycle hooks and move tools with simpler requestReview/concludeSession flow.\n\n---\n\n## Part 1: Cleanup\n\n**Remove lifecycle hooks entirely:**\n- Delete `internal/lifecycle/` package\n- Remove lifecycle config from `.cortex/cortex.yaml` schema\n- Remove hook execution from all MCP tools\n\n**Remove ticket move tools:**\n- Delete `moveTicketToProgress`, `moveTicketToReview`, `moveTicketToDone` from `tools_ticket.go`\n- Keep `readTicket` and `addTicketComment` (remove hook execution from addTicketComment)\n\n---\n\n## Part 2: New MCP Tools + Schema\n\n**Session schema update:**\n```go\ntype Session struct {\n    // ... existing\n    RequestedReviews []ReviewRequest `json:\"requested_reviews\"`\n}\n\ntype ReviewRequest struct {\n    RepoPath    string    `json:\"repo_path\"`\n    Summary     string    `json:\"summary\"`\n    RequestedAt time.Time `json:\"requested_at\"`\n}\n```\n\n**New ticket agent tools:**\n\n`requestReview` - Agent calls when work is ready for review\n- Input: `repo_path` (string), `summary` (string)\n- Appends to `Session.RequestedReviews`\n- Can be called multiple times (multi-repo)\n\n`concludeSession` - Agent calls to end session (from approve prompt)\n- Input: `full_report` (string - commits, pushed branches, key decisions, etc.)\n- Stores report as `ticket_done` comment on the ticket\n- Moves ticket to done\n- Ends session (sets `ended_at`)\n\n---\n\n## Part 3: Prompt Templates\n\nCreate 5 files in `.cortex/prompts/`:\n\n**ticket-system.md** (appended via `--append-system-prompt`)\n- Instructions to call `mcp__cortex__requestReview` after finalizing work\n- Can call multiple times for multi-repo\n- Use `mcp__cortex__addTicketComment` for decisions/blockers\n\n**ticket.md** (prompt for non-worktree spawn)\n- Template vars: `{{.ProjectPath}}`, `{{.TicketID}}`, `{{.TicketTitle}}`, `{{.TicketBody}}`\n- User-customizable (git checkout instructions, etc.)\n\n**ticket-worktree.md** (prompt for worktree spawn)\n- Same as ticket.md + `{{.WorktreePath}}`, `{{.WorktreeBranch}}`\n- Says \"you are in a worktree\"\n\n**approve.md** (prompt for non-worktree approve)\n- Instructions to commit, push\n- Call `mcp__cortex__concludeSession` with full report\n\n**approve-worktree.md** (prompt for worktree approve)\n- Merge worktree branch to main\n- Push\n- Call `mcp__cortex__concludeSession`\n\n---\n\n## Part 4: Spawn Flow Update\n\nUpdate spawn to use new prompts:\n- Prompt: render `ticket.md` or `ticket-worktree.md`\n- Add `--append-system-prompt` with `ticket-system.md` content\n- Install prompt files via `cortex init` (error if missing)\n\n---\n\n## Part 5: Approve Flow\n\nWhen user triggers approve (TUI or CLI):\n1. Render `approve.md` or `approve-worktree.md`\n2. Send content to agent's tmux pane via keystroke\n3. Agent commits/pushes/merges, calls `concludeSession`\n4. `concludeSession` moves ticket to done, ends session\n\n---\n\n## Implementation\n\n### Commits Pushed\n- `5e2a240` feat: implement ticket workflow v2 with requestReview/concludeSession flow\n\n### Key Files Changed\n\n**Deleted:**\n- `internal/lifecycle/` (entire package - hooks.go, template.go, errors.go, hooks_test.go)\n- `internal/daemon/mcp/helpers.go`\n\n**New files:**\n- `internal/install/prompts.go` - Default prompt templates\n- `internal/prompt/template.go` - Template rendering with TicketVars\n\n**Modified:**\n- `internal/project/config/config.go` - Removed LifecycleConfig\n- `internal/ticket/ticket.go` - Added ReviewRequest and RequestedReviews to Session\n- `internal/ticket/store.go` - Added AddReviewRequest method\n- `internal/daemon/mcp/types.go` - Added RequestReviewInput/Output, ConcludeSessionInput/Output\n- `internal/daemon/mcp/tools_ticket.go` - Replaced move tools with requestReview/concludeSession\n- `internal/daemon/mcp/server.go` - Removed lifecycle dependency\n- `internal/daemon/api/deps.go` - Removed HookExecutor\n- `internal/daemon/api/server.go` - Added POST /sessions/{id}/approve route\n- `internal/daemon/api/sessions.go` - Added Approve handler\n- `internal/core/spawn/spawn.go` - Updated to use new template system\n- `internal/prompt/prompt.go` - Added new path functions\n- `internal/install/install.go` - Added creation of 5 new prompt files\n- `internal/cli/sdk/client.go` - Added ApproveSession method\n- `internal/cli/tui/kanban/model.go` - Added approve action with 'a' key\n- `internal/cli/tui/kanban/keys.go` - Added KeyApprove constant\n- `cmd/cortexd/commands/serve.go` - Removed lifecycle executor\n\n### Important Decisions\n- Prompts fall back gracefully (e.g., if ticket-system.md missing, uses legacy ticket-agent.md)\n- Approve sends prompt via tmux send-keys to agent pane\n- ReviewRequest stored in Session.RequestedReviews array (supports multi-repo)\n- concludeSession adds ticket_done comment before ending session\n\n### Scope Changes\n- None - implemented as specified",
  "dates": {
    "created": "2026-01-24T14:28:58Z",
    "updated": "2026-01-24T14:28:58Z",
    "done": "2026-01-24T14:28:58Z"
  },
  "comments": [],
  "session": null
}
